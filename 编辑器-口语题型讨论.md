# 编辑器 - 口语题型设计讨论

本文档基于 `口语考试题型流程说明.md` 分析现有移动端实现，探讨如何设计更灵活、可视化的口语题编辑器。

---

## 一、现有实现分析

### 1.1 口语题型总览

| partType | 题型名称 | 复杂度 | 核心特点 |
|----------|---------|--------|---------|
| 1 | 短文朗读 | ⭐⭐ | 单段文本 + 示范音频 + 录音 |
| 2 | 口头选择 | ⭐⭐⭐ | 多小题循环 + 选项显示 |
| 3 | 情景问答 | ⭐⭐⭐ | 情景提示 + 多小题 + 关键词评测 |
| 4 | 口头作文 | ⭐⭐ | 提示信息 + 开放式录音 |
| 5 | 听后转述 | ⭐⭐⭐⭐⭐ | 最复杂：填空 + 多段音频 + 转述 |
| 6 | 单句练习 | ⭐⭐ | 句子随机排序 + 连读录音 |
| 7 | 单词朗读 | ⭐⭐⭐ | 逐词循环 + 音标评测 |
| 8 | 朗读并回答 | ⭐⭐⭐⭐ | 两阶段：朗读 + 问答 |
| 12 | 转述阅读 | ⭐⭐⭐ | 材料浏览 + 多遍播放 + 转述 |

### 1.2 流程复杂度来源

```
┌─────────────────────────────────────────────────────────────┐
│                    口语题复杂度因素                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  多步骤流程        多音频文件        多时间参数               │
│  ───────────      ───────────      ───────────              │
│  介绍 → 显示       introduction     readTimes               │
│  → 播放 → 准备     voice            finishTimes             │
│  → 录音 → 评测     firstVoice       firstReadyTimes         │
│                   secondVoice      secondReadyTimes        │
│                   prepareVoice     eachReadTimes           │
│                   startVoice       repostTimes             │
│                                                             │
│  播放次数控制      评测模式          子题循环                 │
│  ───────────      ───────────      ───────────              │
│  firstCount       E: 文章朗读       partType 2,3,5,7,8      │
│  secondCount      B: 情景问答       需要循环处理多个小题      │
│                   C: 转述评测                                │
│                   G: 单词音标                                │
│                   H: 口头选择                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 典型流程示例

#### 简单流程：短文朗读 (partType=1)

```
┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
│ 题型介绍  │ → │ 播放示范  │ → │ 阅读准备  │ → │ 录音朗读  │ → │ 评测打分  │
│          │   │ 音频     │   │ 倒计时   │   │          │   │          │
└──────────┘   └──────────┘   └──────────┘   └──────────┘   └──────────┘
     1步           2步           3步           4步           5步
```

#### 复杂流程：听后转述 (partType=5)

```
┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐
│ 题型   │ → │ 播放   │ → │ 显示   │ → │ 阅读   │ → │ 播放   │
│ 介绍   │   │ 描述1  │   │ 填空题 │   │ 准备   │   │ 录音   │
└────────┘   └────────┘   └────────┘   └────────┘   │ N遍   │
                                                    └────────┘
                                                        ↓
┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐
│ 评测   │ ← │ 录音   │ ← │ 嘀声   │ ← │ 转述   │ ← │ 播放   │
│ 打分   │   │ 转述   │   │ 提示   │   │ 准备   │   │ 描述2  │
└────────┘   └────────┘   └────────┘   └────────┘   └────────┘
                                                        ↑
                                        ┌────────┐      │
                                        │ 填空   │ ─────┘
                                        │ 答题   │
                                        └────────┘
```

### 1.4 界面结构

移动端采用三区布局：内容区 + 控制区 + 底部按钮栏

```
┌─────────────────────────────────┐
│           导航栏                 │
├─────────────────────────────────┤
│                                 │
│         内容区 (上区域)           │
│                                 │
│    显示题目内容、文本、图片        │
│    根据步骤动态切换显示内容        │
│                                 │
├─────────────────────────────────┤
│                                 │
│         控制区 (下区域)           │
│                                 │
│    显示当前步骤的控制组件：        │
│    - 音频：播放器 + 进度条 + 倒计时│
│    - 准备：倒计时数字 + 进度条     │
│    - 录音：波形图 + 计时器        │
│                                 │
├─────────────────────────────────┤
│  [下一大题]           [下一步]   │  ← 固定底部按钮栏
└─────────────────────────────────┘
```

**关键布局规则**：
- **底部按钮栏**：始终固定在屏幕最底部，不随内容滚动
- **下一步按钮**：位于底部栏右侧，主要操作入口
- **控制区**：位于内容区和底部按钮栏之间，显示当前步骤的计时/播放信息

---

## 二、编辑器设计目标

### 2.1 核心需求

1. **可视化**：编辑人员能直观看到考试流程
2. **灵活性**：支持配置各种参数而不需要理解代码
3. **易用性**：减少学习成本，提供合理默认值
4. **预览**：所见即所得，可模拟考试流程
5. **验证**：自动检查必填项和配置合理性

### 2.2 设计原则

```
┌─────────────────────────────────────────────────────────────┐
│                      设计原则                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  模板驱动              步骤可视化            渲染器复用        │
│  ─────────            ─────────            ─────────        │
│  不从零开始配置         流程 = 步骤卡片序列    编辑器预览        │
│  选择题型自动生成       每步可独立配置         = 考试渲染器      │
│  标准流程模板          清晰展示执行顺序                        │
│                                                             │
│  渐进式复杂度          实时预览              智能默认值        │
│  ─────────            ─────────            ─────────        │
│  简单模式：填内容       模拟考试流程          时间、次数等       │
│  高级模式：改流程       可单步/自动播放        提供推荐值        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、数据结构设计

### 3.1 核心类型定义

```typescript
// types/question.ts

// 口语题型枚举
type SpeakingPartType = 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 12

// 评测模式
type AssessmentMode = 'E' | 'B' | 'C' | 'G' | 'H'

// 口语题主结构
interface SpeakingStepsQuestion {
  type: 'speaking-steps'
  partType: SpeakingPartType
  title: string

  // 核心：步骤序列
  steps: SpeakingStep[]

  // 小题列表（部分题型需要）
  subQuestions?: SpeakingSubQuestion[]

  // 评测配置
  assessment: AssessmentConfig

  // 标签
  tags?: TagSelection
}

// 小题结构
interface SpeakingSubQuestion {
  id: string
  content: RichTextContent           // 题目内容
  options?: ChoiceOption[]           // 选项（口头选择题）
  referenceAnswer?: string           // 参考答案
  keywords?: string[]                // 关键词（情景问答）
  audio?: AudioFile                  // 小题音频
}

// 评测配置
interface AssessmentConfig {
  mode: AssessmentMode
  referenceText?: string             // 参考文本（朗读评测）
  grammar?: string                   // JSGF语法（情景问答）
  keywords?: KeywordConfig[]         // 关键词配置
  acceptableAnswers?: string[]       // 可接受答案列表
}

// 音频文件
interface AudioFile {
  type: 'upload' | 'url' | 'record'
  url: string
  duration?: number                  // 时长（秒）
  name?: string                      // 文件名
}
```

### 3.2 步骤类型定义

```typescript
// 步骤联合类型
type SpeakingStep =
  | IntroductionStep      // 题型介绍
  | DisplayContentStep    // 显示内容
  | PlayAudioStep         // 播放音频
  | CountdownStep         // 倒计时
  | RecordStep            // 录音
  | FillBlankStep         // 填空
  | LoopSubQuestionsStep  // 小题循环

// ========== 各步骤详细定义 ==========

// 1. 题型介绍步骤
interface IntroductionStep {
  type: 'introduction'
  title: string                      // 题型名称
  description: string                // 说明文字
  gifImage?: string                  // 动画演示图
  audio?: AudioFile                  // 介绍音频
  duration?: number                  // 自动跳过时间
}

// 2. 显示内容步骤
interface DisplayContentStep {
  type: 'display-content'
  id: string
  area: 'upper' | 'lower' | 'fullscreen'
  content: RichTextContent           // 富文本内容
  image?: string                     // 配图
  imageZoomable?: boolean            // 图片可放大
  label?: string                     // 区域标签
}

// 3. 播放音频步骤
interface PlayAudioStep {
  type: 'play-audio'
  id: string
  audio: AudioFile | null            // 音频文件
  playCount: number                  // 播放次数
  showProgress: boolean              // 显示进度条
  showPlayCount?: boolean            // 显示"第X遍播放"
  label?: string                     // 提示文字
  canPause?: boolean                 // 允许暂停
}

// 4. 倒计时步骤
interface CountdownStep {
  type: 'countdown'
  id: string
  duration: number                   // 倒计时秒数
  label: string                      // 提示文字，如"请认真阅读"
  showProgress: boolean              // 显示进度条
  showSkipButton?: boolean           // 显示跳过按钮
  skipButtonText?: string            // 跳过按钮文字
  skipAction?: 'next-step' | 'start-record'
}

// 5. 录音步骤
interface RecordStep {
  type: 'record'
  id: string
  duration: number                   // 最大录音时长
  minDuration?: number               // 最小录音时长
  playBeepBefore: boolean            // 录音前播放嘀声
  showTimer: boolean                 // 显示录音计时
  showStopButton: boolean            // 显示停止按钮
  stopButtonText?: string            // 停止按钮文字
  assessmentMode: AssessmentMode     // 评测模式
  referenceText?: string             // 评测参考文本
}

// 6. 填空步骤
interface FillBlankStep {
  type: 'fill-blank'
  id: string
  duration: number                   // 答题时间
  blanks: BlankItem[]                // 填空项
  showKeyboard: boolean              // 显示键盘
}

interface BlankItem {
  id: string
  placeholder?: string
  answer: string                     // 正确答案
  acceptableAnswers?: string[]       // 可接受答案
}

// 7. 小题循环步骤
interface LoopSubQuestionsStep {
  type: 'loop-sub-questions'
  id: string
  // 每个小题执行的步骤模板
  stepsPerQuestion: SpeakingStep[]
}
```

### 3.3 步骤 ID 与引用

```typescript
// 步骤可以通过 ID 相互引用
// 例如：显示内容步骤可以引用在哪个音频播放时显示

interface PlayAudioStep {
  // ...
  displayContentIds?: string[]       // 播放时显示哪些内容
}

interface CountdownStep {
  // ...
  displayContentIds?: string[]       // 倒计时时显示哪些内容
}
```

---

## 四、编辑器 UI 设计

### 4.1 整体布局

```
┌─────────────────────────────────────────────────────────────────────┐
│  口语题编辑器                                        [保存] [预览]   │
├────────────┬────────────────────────────┬───────────────────────────┤
│            │                            │                           │
│  左侧面板   │      中间：流程编辑区        │      右侧：预览区          │
│            │                            │                           │
│ ┌────────┐ │                            │  ┌─────────────────────┐  │
│ │题型选择 │ │                            │  │                     │  │
│ │        │ │                            │  │    考试界面预览       │  │
│ │○ 短文朗读│ │                            │  │                     │  │
│ │○ 口头选择│ │                            │  │   (模拟手机屏幕)     │  │
│ │○ 情景问答│ │                            │  │                     │  │
│ │○ 口头作文│ │                            │  │                     │  │
│ │● 听后转述│ │                            │  │                     │  │
│ │○ 单句练习│ │                            │  └─────────────────────┘  │
│ │○ 单词朗读│ │                            │                           │
│ │○ 朗读回答│ │      (步骤卡片列表)         │  ┌─────────────────────┐  │
│ │○ 转述阅读│ │                            │  │ 预览控制             │  │
│ └────────┘ │                            │  │                     │  │
│            │                            │  │ [◀] [▶播放] [▶▶]    │  │
│ ┌────────┐ │                            │  │                     │  │
│ │基础设置 │ │                            │  │ 步骤: 3/8           │  │
│ │        │ │                            │  │ ████████░░░░        │  │
│ │标题:   │ │                            │  └─────────────────────┘  │
│ │[_____] │ │                            │                           │
│ │        │ │                            │                           │
│ │评测模式:│ │                            │                           │
│ │[C模式▾]│ │                            │                           │
│ └────────┘ │                            │                           │
│            │                            │                           │
│ ┌────────┐ │                            │                           │
│ │小题管理 │ │                            │                           │
│ │        │ │                            │                           │
│ │[+添加] │ │                            │                           │
│ │1. 小题1│ │                            │                           │
│ │2. 小题2│ │                            │                           │
│ └────────┘ │                            │                           │
│            │                            │                           │
└────────────┴────────────────────────────┴───────────────────────────┘
```

### 4.2 流程编辑区（核心）

```
┌─────────────────────────────────────────────────┐
│  流程步骤                          [+ 添加步骤]  │
│  ─────────────────────────────────────────────  │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 1  📢 题型介绍                    [···]  │   │
│  │    ─────────────────────────────────    │   │
│  │    标题: 听后转述                        │   │
│  │    说明: 听录音，完成填空，然后转述       │   │
│  │    [编辑详情]                           │   │
│  └─────────────────────────────────────────┘   │
│                      │                          │
│                      ▼                          │
│  ┌─────────────────────────────────────────┐   │
│  │ 2  🔊 播放音频                    [···]  │   │
│  │    ─────────────────────────────────    │   │
│  │    音频: description_1.mp3  [▶ 试听]    │   │
│  │    播放次数: 1                          │   │
│  │    [上传音频] [录制]                    │   │
│  └─────────────────────────────────────────┘   │
│                      │                          │
│                      ▼                          │
│  ┌─────────────────────────────────────────┐   │
│  │ 3  📖 显示内容                    [···]  │   │
│  │    ─────────────────────────────────    │   │
│  │    区域: 上区域                         │   │
│  │    ┌─────────────────────────────┐     │   │
│  │    │ 填空题内容预览...            │     │   │
│  │    └─────────────────────────────┘     │   │
│  │    [编辑内容]                           │   │
│  └─────────────────────────────────────────┘   │
│                      │                          │
│                      ▼                          │
│  ┌─────────────────────────────────────────┐   │
│  │ 4  ⏱️ 倒计时                      [···]  │   │
│  │    ─────────────────────────────────    │   │
│  │    时长: [30] 秒                        │   │
│  │    提示: 请浏览提示信息                  │   │
│  │    □ 显示跳过按钮                       │   │
│  └─────────────────────────────────────────┘   │
│                      │                          │
│                      ▼                          │
│  ┌─────────────────────────────────────────┐   │
│  │ 5  🔊 播放音频                    [···]  │   │
│  │    ─────────────────────────────────    │   │
│  │    音频: main_audio.mp3  [▶ 试听]       │   │
│  │    播放次数: [2]  ☑ 显示"第X遍播放"     │   │
│  └─────────────────────────────────────────┘   │
│                      │                          │
│                     ...                         │
│                      │                          │
│                      ▼                          │
│  ┌─────────────────────────────────────────┐   │
│  │ 8  🎤 录音                        [···]  │   │
│  │    ─────────────────────────────────    │   │
│  │    时长: [90] 秒                        │   │
│  │    ☑ 录音前播放嘀声                     │   │
│  │    ☑ 显示停止按钮                       │   │
│  │    评测模式: C (转述评测)               │   │
│  └─────────────────────────────────────────┘   │
│                      │                          │
│                      ▼                          │
│  ┌─────────────────────────────────────────┐   │
│  │ 9  ✅ 评测完成                          │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 4.3 步骤卡片设计

#### 折叠状态

```
┌─────────────────────────────────────────────────┐
│ 4  ⏱️ 倒计时 · 30秒 · "请浏览提示信息"    [▾]  │
└─────────────────────────────────────────────────┘
```

#### 展开状态

```
┌─────────────────────────────────────────────────┐
│ 4  ⏱️ 倒计时                           [▴] [✕] │
├─────────────────────────────────────────────────┤
│                                                 │
│  时长                                           │
│  ┌─────────────────────────────────────────┐   │
│  │ [    30    ] 秒      推荐: 30-60秒      │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  提示文字                                       │
│  ┌─────────────────────────────────────────┐   │
│  │ 请浏览提示信息                           │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  选项                                           │
│  ☑ 显示进度条                                  │
│  □ 显示跳过按钮                                │
│                                                 │
│  同时显示的内容                                  │
│  ☑ 3-填空题内容                                │
│  □ 5-提示信息                                  │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 4.4 音频上传组件

```
┌─────────────────────────────────────────────────┐
│  音频文件                                        │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │  ○ 上传文件    ● 在线录制    ○ URL地址   │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │                                         │   │
│  │         🎤 点击开始录制                  │   │
│  │                                         │   │
│  │    或拖拽音频文件到此处                   │   │
│  │                                         │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  已上传:                                        │
│  ┌─────────────────────────────────────────┐   │
│  │ 🎵 description.mp3   02:30              │   │
│  │                      [▶播放] [✕删除]    │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 4.5 预览区设计

```
┌─────────────────────────────────────────┐
│          考试界面预览                    │
├─────────────────────────────────────────┤
│ ┌─────────────────────────────────────┐ │
│ │         模拟手机屏幕                 │ │
│ │  ┌───────────────────────────────┐  │ │
│ │  │ ← 听后转述              提交   │  │ │  ← 导航栏
│ │  ├───────────────────────────────┤  │ │
│ │  │                               │  │ │
│ │  │    The quick brown fox        │  │ │
│ │  │    jumps over the ___         │  │ │  ← 内容区
│ │  │    dog.                       │  │ │    (可滚动)
│ │  │                               │  │ │
│ │  │    1. ______                  │  │ │
│ │  │    2. ______                  │  │ │
│ │  │                               │  │ │
│ │  ├───────────────────────────────┤  │ │
│ │  │                               │  │ │
│ │  │    ⏱️ 25                       │  │ │  ← 控制区
│ │  │    ████████████░░░░░░         │  │ │    (倒计时/播放器)
│ │  │    请浏览提示信息              │  │ │
│ │  │                               │  │ │
│ │  ├───────────────────────────────┤  │ │
│ │  │ [下一大题]          [下一步]  │  │ │  ← 底部按钮栏
│ │  └───────────────────────────────┘  │ │    (固定底部)
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│  预览控制（编辑器面板）                   │
│                                         │
│  当前步骤: 4/9 - 倒计时                  │
│  ████████████░░░░░░░░░░░░               │
│                                         │
│  [|◀ 上一步]  [▶ 播放模拟]  [下一步 ▶|]  │
│                                         │
│  ☑ 自动播放    播放速度: [1x ▾]         │
└─────────────────────────────────────────┘
```

**布局要点**：
- 模拟手机屏幕采用三区固定布局：内容区 + 控制区 + 底部按钮栏
- 底部按钮栏始终固定在屏幕最底部
- 控制区显示当前步骤的计时/播放信息
- 预览控制面板属于编辑器界面，用于导航步骤

---

## 五、交互设计

### 5.1 选择题型自动生成模板

```typescript
// 用户选择题型后，自动生成标准步骤序列

function onSelectPartType(partType: SpeakingPartType) {
  const template = createSpeakingTemplate(partType)
  currentQuestion.value = template

  // 显示提示
  showToast(`已生成${getPartTypeName(partType)}标准流程，请填写内容`)
}
```

### 5.2 拖拽排序步骤

```
高级模式下，步骤卡片支持拖拽排序：

┌─────────────────────────────────────────┐
│ 2  🔊 播放音频                          │  ← 拖拽手柄
├─────────────────────────────────────────┤
        │
        │ 拖拽中...
        ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
  放置位置预览
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
┌─────────────────────────────────────────┐
│ 3  📖 显示内容                          │
└─────────────────────────────────────────┘
```

### 5.3 添加步骤

```
点击 [+ 添加步骤] 弹出选择菜单：

┌─────────────────────────┐
│  添加步骤               │
├─────────────────────────┤
│  📢 题型介绍            │
│  📖 显示内容            │
│  🔊 播放音频            │
│  ⏱️ 倒计时              │
│  🎤 录音                │
│  📝 填空                │
│  🔄 小题循环            │
└─────────────────────────┘
```

### 5.4 步骤验证

```
保存时自动验证：

⚠️ 验证问题：
├── 步骤2：音频文件未上传
├── 步骤5：录音时长不能为0
└── 步骤7：缺少评测参考文本

[忽略继续] [返回修改]
```

---

## 六、模板示例

### 6.1 短文朗读 (partType=1)

```typescript
{
  type: 'speaking-steps',
  partType: 1,
  title: '短文朗读',
  steps: [
    {
      type: 'introduction',
      title: '短文朗读',
      description: '请先听示范朗读，然后朗读短文',
      duration: 5
    },
    {
      type: 'display-content',
      id: 'passage',
      area: 'upper',
      content: { type: 'richtext', content: [] }  // 待编辑
    },
    {
      type: 'play-audio',
      id: 'demo-audio',
      audio: null,  // 待上传
      playCount: 1,
      showProgress: true,
      displayContentIds: ['passage']
    },
    {
      type: 'countdown',
      id: 'prepare',
      duration: 30,
      label: '请准备朗读',
      showProgress: true,
      showSkipButton: true,
      skipButtonText: '开始录音',
      displayContentIds: ['passage']
    },
    {
      type: 'record',
      id: 'record',
      duration: 60,
      playBeepBefore: true,
      showTimer: true,
      showStopButton: true,
      assessmentMode: 'E'
    }
  ],
  assessment: {
    mode: 'E',
    referenceText: ''  // 待填写
  }
}
```

### 6.2 听后转述 (partType=5)

```typescript
{
  type: 'speaking-steps',
  partType: 5,
  title: '听后转述',
  steps: [
    { type: 'introduction', title: '听后转述', description: '...' },
    { type: 'play-audio', id: 'desc1', audio: null, playCount: 1 },
    { type: 'display-content', id: 'blanks', area: 'upper', content: {...} },
    { type: 'countdown', id: 'read-prepare', duration: 30, label: '浏览提示信息' },
    { type: 'play-audio', id: 'main-audio-1', audio: null, playCount: 2, showPlayCount: true },
    { type: 'play-audio', id: 'prepare-audio', audio: null, playCount: 1 },
    { type: 'fill-blank', id: 'fill', duration: 60, blanks: [...] },
    { type: 'play-audio', id: 'desc2', audio: null, playCount: 1 },
    { type: 'play-audio', id: 'main-audio-2', audio: null, playCount: 2, showPlayCount: true },
    { type: 'countdown', id: 'retell-prepare', duration: 30, label: '转述准备' },
    { type: 'record', id: 'retell', duration: 90, playBeepBefore: true, assessmentMode: 'C' }
  ],
  assessment: { mode: 'C' }
}
```

---

## 七、与现有架构集成

### 7.1 组件结构

```
components/
├── editor/
│   └── speaking/
│       ├── SpeakingStepsEditor.vue      # 主编辑器
│       ├── StepCard.vue                  # 步骤卡片
│       ├── StepIntroductionEditor.vue    # 介绍步骤编辑
│       ├── StepDisplayContentEditor.vue  # 显示内容编辑
│       ├── StepPlayAudioEditor.vue       # 播放音频编辑
│       ├── StepCountdownEditor.vue       # 倒计时编辑
│       ├── StepRecordEditor.vue          # 录音步骤编辑
│       ├── StepFillBlankEditor.vue       # 填空步骤编辑
│       ├── AudioUploader.vue             # 音频上传组件
│       └── PartTypeSelector.vue          # 题型选择器
│
└── renderer/
    └── speaking/
        ├── SpeakingStepsRenderer.vue     # 主渲染器（预览+考试共用）
        ├── StepIntroduction.vue          # 介绍步骤渲染
        ├── StepDisplayContent.vue        # 显示内容渲染
        ├── StepPlayAudio.vue             # 播放音频渲染
        ├── StepCountdown.vue             # 倒计时渲染
        ├── StepRecord.vue                # 录音渲染
        └── StepFillBlank.vue             # 填空渲染
```

### 7.2 数据流

```
┌─────────────────┐     v-model      ┌─────────────────┐
│                 │ ◄──────────────► │                 │
│ SpeakingSteps   │                  │ SpeakingSteps   │
│ Editor          │                  │ Question        │
│                 │                  │ (JSON Data)     │
└────────┬────────┘                  └────────┬────────┘
         │                                    │
         │ props                              │ props
         ▼                                    ▼
┌─────────────────┐                  ┌─────────────────┐
│                 │                  │                 │
│ SpeakingSteps   │  ◄── 同一组件 ──► │ SpeakingSteps   │
│ Renderer        │                  │ Renderer        │
│ (预览模式)       │                  │ (考试模式)       │
│                 │                  │                 │
└─────────────────┘                  └─────────────────┘
```

---

## 八、设计决策（已确定）

### 8.1 流程定制化程度

**决策**：✅ 允许编辑人员修改步骤顺序

- 支持拖拽排序步骤
- 支持添加/删除步骤
- 提供题型模板作为起点，但不限制修改

### 8.2 小题循环的处理

**决策**：✅ 编辑区域要让编辑人员易懂，预览支持点击下一步导航

详见下方「九、小题循环编辑方案」

### 8.3 音频存储方案

**决策**：✅ Demo 阶段暂不考虑

- 使用本地 `/static/` 目录的示例音频
- 后续再设计云存储方案

### 8.4 预览实现方式

**决策**：✅ 手动模式

- 点击「下一步」切换步骤
- 倒计时步骤：只展示 UI，不真正倒计时
- 音频播放：按钮可点击，支持真实播放
- 录音步骤：展示录音界面 UI，不真正录音

---

## 九、小题循环编辑方案（重点）

### 9.1 问题分析

部分题型包含多个小题，每个小题需要循环执行相同的步骤：

| 题型 | 小题特点 |
|------|---------|
| partType=2 口头选择 | 每题：播放题目音频 → 显示选项 → 录音 |
| partType=3 情景问答 | 每题：播放问题 → 录音回答 |
| partType=7 单词朗读 | 每词：显示单词 → 倒计时 → 录音 |
| partType=8 朗读回答 | 每题：准备 → 播放嘀声 → 录音 |

**挑战**：如何让编辑人员理解「循环」概念，同时能方便地编辑每个小题的内容？

### 9.2 编辑区设计方案

#### 方案：双层结构 + 可视化循环标记

```
┌─────────────────────────────────────────────────────────────┐
│  流程步骤                                      [+ 添加步骤]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ 1  📢 题型介绍                                         │ │
│  │    口头选择题，听问题后说出答案...                       │ │
│  └───────────────────────────────────────────────────────┘ │
│                          ↓                                  │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ 2  📖 显示所有小题列表                                  │ │
│  │    预览阶段显示所有题目                                  │ │
│  └───────────────────────────────────────────────────────┘ │
│                          ↓                                  │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ 3  🔊 播放对话音频                                      │ │
│  │    dialogue.mp3  [▶ 试听]                              │ │
│  └───────────────────────────────────────────────────────┘ │
│                          ↓                                  │
│  ╔═══════════════════════════════════════════════════════╗ │
│  ║ 🔄 小题循环                         共 3 题            ║ │
│  ║━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━║ │
│  ║                                                       ║ │
│  ║  以下步骤对每个小题重复执行：                            ║ │
│  ║                                                       ║ │
│  ║  ┌─────────────────────────────────────────────────┐ ║ │
│  ║  │ 3.1  🔊 播放小题音频                             │ ║ │
│  ║  │      使用小题自带的音频                          │ ║ │
│  ║  └─────────────────────────────────────────────────┘ ║ │
│  ║                        ↓                             ║ │
│  ║  ┌─────────────────────────────────────────────────┐ ║ │
│  ║  │ 3.2  📖 显示当前小题                             │ ║ │
│  ║  │      显示题目内容和选项                          │ ║ │
│  ║  └─────────────────────────────────────────────────┘ ║ │
│  ║                        ↓                             ║ │
│  ║  ┌─────────────────────────────────────────────────┐ ║ │
│  ║  │ 3.3  🎤 录音                                     │ ║ │
│  ║  │      时长: 15秒  评测模式: H                      │ ║ │
│  ║  └─────────────────────────────────────────────────┘ ║ │
│  ║                                                       ║ │
│  ╚═══════════════════════════════════════════════════════╝ │
│                          ↓                                  │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ 4  ✅ 评测完成                                         │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 设计要点

1. **视觉区分**：循环区域用双线边框 + 背景色区分
2. **循环标识**：顶部显示 🔄 图标 + "共 N 题"
3. **说明文字**："以下步骤对每个小题重复执行"
4. **步骤编号**：循环内步骤用子编号（3.1, 3.2, 3.3）

### 9.3 小题管理面板

左侧面板管理小题内容：

```
┌─────────────────────────────┐
│ 小题管理                     │
├─────────────────────────────┤
│                             │
│ ┌─────────────────────────┐ │
│ │ 小题 1              [✎] │ │
│ │ ─────────────────────── │ │
│ │ What color is the sky?  │ │
│ │ A. Red  B. Blue  C. ... │ │
│ │ 🎵 q1.mp3               │ │
│ └─────────────────────────┘ │
│                             │
│ ┌─────────────────────────┐ │
│ │ 小题 2              [✎] │ │
│ │ ─────────────────────── │ │
│ │ How many apples?        │ │
│ │ A. One  B. Two  C. ...  │ │
│ │ 🎵 q2.mp3               │ │
│ └─────────────────────────┘ │
│                             │
│ ┌─────────────────────────┐ │
│ │ 小题 3              [✎] │ │
│ │ ─────────────────────── │ │
│ │ Where is the cat?       │ │
│ │ A. Home  B. Park  C. ...│ │
│ │ 🎵 q3.mp3               │ │
│ └─────────────────────────┘ │
│                             │
│      [+ 添加小题]            │
│                             │
└─────────────────────────────┘
```

点击 [✎] 弹出小题编辑对话框：

```
┌───────────────────────────────────────────────────┐
│ 编辑小题 1                                   [×]  │
├───────────────────────────────────────────────────┤
│                                                   │
│ 题目内容                                          │
│ ┌───────────────────────────────────────────────┐│
│ │ What color is the sky?                        ││
│ └───────────────────────────────────────────────┘│
│                                                   │
│ 选项                                              │
│ ┌──────────────────────┐ ○ 正确答案             │
│ │ A. Red               │                         │
│ └──────────────────────┘                         │
│ ┌──────────────────────┐ ● 正确答案             │
│ │ B. Blue              │                         │
│ └──────────────────────┘                         │
│ ┌──────────────────────┐ ○ 正确答案             │
│ │ C. Green             │                         │
│ └──────────────────────┘                         │
│ [+ 添加选项]                                      │
│                                                   │
│ 小题音频                                          │
│ ┌───────────────────────────────────────────────┐│
│ │ 🎵 question_1.mp3           [▶播放] [✕删除]  ││
│ └───────────────────────────────────────────────┘│
│ [上传音频] [录制]                                 │
│                                                   │
│                            [取消]  [保存]         │
└───────────────────────────────────────────────────┘
```

### 9.4 预览区的小题循环

预览时，循环会被「展开」显示实际执行流程：

```
┌─────────────────────────────────────────┐
│          预览控制                        │
├─────────────────────────────────────────┤
│                                         │
│  步骤列表：                              │
│                                         │
│  ✓ 1. 题型介绍                          │
│  ✓ 2. 显示所有小题                       │
│  ✓ 3. 播放对话音频                       │
│  ─────── 小题循环 ───────                │
│  → 4. [小题1] 播放音频    ← 当前步骤     │
│    5. [小题1] 显示题目                   │
│    6. [小题1] 录音                       │
│    7. [小题2] 播放音频                   │
│    8. [小题2] 显示题目                   │
│    9. [小题2] 录音                       │
│    10. [小题3] 播放音频                  │
│    11. [小题3] 显示题目                  │
│    12. [小题3] 录音                      │
│  ───────────────────────                │
│    13. 评测完成                          │
│                                         │
│  [◀ 上一步]            [下一步 ▶]       │
│                                         │
│  当前: 4/13 - 小题1 播放音频             │
│  ████████░░░░░░░░░░░░░░░░               │
│                                         │
└─────────────────────────────────────────┘
```

**交互特点**：
- 循环被展开成实际步骤序列
- 每步显示 [小题N] 标识
- 点击「下一步」逐步推进
- 进度条显示总体进度

---

## 十、渲染器界面布局规范

### 10.1 整体布局结构

考试/预览界面采用**三区固定布局**：

```
┌─────────────────────────────────────────┐
│  导航栏 (NavBar)                         │
│  ← 返回    题型名称           提交/时间   │
├─────────────────────────────────────────┤
│                                         │
│                                         │
│           内容区 (ContentArea)           │
│                                         │
│      题目文本 / 图片 / 选项 / 填空        │
│      可滚动，占据剩余空间                 │
│                                         │
│                                         │
├─────────────────────────────────────────┤
│                                         │
│           控制区 (ControlArea)           │
│                                         │
│      音频播放器 / 倒计时 / 录音状态       │
│      固定高度，不滚动                     │
│                                         │
├─────────────────────────────────────────┤
│  [下一大题]                   [下一步]   │  ← 底部按钮栏
└─────────────────────────────────────────┘
```

### 10.2 底部按钮栏规范

**位置**：始终固定在屏幕最底部，不随内容滚动

**布局**：
```
┌─────────────────────────────────────────┐
│                                         │
│  [下一大题]                   [下一步]   │
│                                         │
│  左侧按钮          中间留白    右侧按钮   │
└─────────────────────────────────────────┘
```

**按钮说明**：
- **下一步**（右侧）：主操作按钮，推进当前题目的流程步骤
- **下一大题**（左侧）：次要按钮，跳过当前大题进入下一大题

**按钮状态**：
- 正常状态：可点击，主色调
- 禁用状态：灰色，在某些自动流程中不可跳过
- 隐藏情况：自动播放音频期间可选择隐藏

### 10.3 控制区内容规范

控制区根据当前步骤类型显示不同内容：

#### 音频播放状态

```
┌─────────────────────────────────────────┐
│                                         │
│   🔊 正在播放                            │
│   ━━━━━━━━━●━━━━━━━━━━  01:25 / 03:00   │
│                                         │
│          第 1 遍播放，共 2 遍            │
│                                         │
└─────────────────────────────────────────┘
```

**布局要素**：
- 播放图标 + 状态文字（顶部）
- 进度条 + 当前时间/总时长（中间）
- 播放遍数提示（底部，如需要）

#### 倒计时准备状态

```
┌─────────────────────────────────────────┐
│                                         │
│              ⏱️ 25                       │
│                                         │
│   ████████████████░░░░░░░░░░░░░░░░░░   │
│                                         │
│          请认真阅读以上问题              │
│                                         │
└─────────────────────────────────────────┘
```

**布局要素**：
- 大号倒计时数字（居中，醒目）
- 进度条（显示剩余时间比例）
- 提示文字（说明当前阶段）

#### 录音状态

```
┌─────────────────────────────────────────┐
│                                         │
│              🎤 录音中                   │
│                                         │
│         ▁ ▂ ▄ ▆ █ ▆ ▄ ▂ ▁              │
│                                         │
│            00:15 / 60                   │
│                                         │
│            [完成录音]                   │
└─────────────────────────────────────────┘
```

**布局要素**：
- 录音图标 + 状态文字（顶部）
- 音频波形动画（中间）
- 已录制时间 / 最大时长（中间）
- 完成按钮（可选，底部）

### 10.4 控制区与底部按钮的关系

```
┌─────────────────────────────────────────┐
│                                         │
│            控制区（动态内容）             │
│                                         │
│   ┌─────────────────────────────────┐   │
│   │  倒计时/播放器/录音状态           │   │
│   │                                 │   │
│   │  这里的内容根据步骤类型变化        │   │
│   └─────────────────────────────────┘   │
│                                         │
├─────────────────────────────────────────┤
│                                         │
│  [下一大题]                   [下一步]   │  ← 永远在最底部
│                                         │
└─────────────────────────────────────────┘
```

**重要原则**：
- 控制区的高度根据内容自适应，但有最大高度限制
- 底部按钮栏永远在控制区下方
- 即使控制区为空，底部按钮栏仍然显示

---

## 十一、预览交互详细设计

### 11.1 预览模式说明

| 步骤类型 | 预览行为 |
|---------|---------|
| 题型介绍 | 显示介绍页 UI |
| 显示内容 | 显示内容 |
| 播放音频 | 显示播放器 UI，**按钮可点击真实播放** |
| 倒计时 | 显示倒计时 UI（固定显示配置的秒数），**不真正倒计时** |
| 录音 | 显示录音 UI，**不真正录音** |
| 填空 | 显示填空 UI，可以输入（但不评测） |

### 11.2 预览区 UI

```
┌─────────────────────────────────────────────────┐
│  预览                                           │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌───────────────────────────────────────────┐ │
│  │                                           │ │
│  │            📱 模拟手机屏幕                 │ │
│  │                                           │ │
│  │  ┌─────────────────────────────────────┐ │ │
│  │  │ ← 口头选择                    提交  │ │ │  ← 导航栏
│  │  ├─────────────────────────────────────┤ │ │
│  │  │                                     │ │ │
│  │  │  1. What color is the sky?          │ │ │  ← 内容区
│  │  │                                     │ │ │    (可滚动)
│  │  │     A. Red                          │ │ │
│  │  │     B. Blue                         │ │ │
│  │  │     C. Green                        │ │ │
│  │  │     D. Yellow                       │ │ │
│  │  │                                     │ │ │
│  │  ├─────────────────────────────────────┤ │ │
│  │  │                                     │ │ │
│  │  │   🔊 正在播放                       │ │ │  ← 控制区
│  │  │   ━━━━━━━━━●━━━━━━  0:12/0:25      │ │ │    (固定高度)
│  │  │                                     │ │ │
│  │  ├─────────────────────────────────────┤ │ │
│  │  │ [下一大题]              [下一步]    │ │ │  ← 底部按钮栏
│  │  └─────────────────────────────────────┘ │ │    (固定底部)
│  │                                           │ │
│  └───────────────────────────────────────────┘ │
│                                                 │
├─────────────────────────────────────────────────┤
│  步骤导航（编辑器控制面板）                       │
│                                                 │
│  当前: 步骤 5/13 - [小题1] 显示题目              │
│                                                 │
│  ┌───────────────────────────────────────────┐ │
│  │ ████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░ │ │
│  └───────────────────────────────────────────┘ │
│                                                 │
│        [◀ 上一步]        [下一步 ▶]             │
│                                                 │
│  ┌───────────────────────────────────────────┐ │
│  │ ○ 1. 题型介绍                             │ │
│  │ ○ 2. 显示所有小题                          │ │
│  │ ○ 3. 播放对话音频                          │ │
│  │ ● 4. [小题1] 播放音频                      │ │
│  │ → 5. [小题1] 显示题目   ← 当前             │ │
│  │ ○ 6. [小题1] 录音                          │ │
│  │ ○ 7. [小题2] 播放音频                      │ │
│  │ ...                                        │ │
│  └───────────────────────────────────────────┘ │
│                                                 │
└─────────────────────────────────────────────────┘
```

**说明**：
- 模拟手机屏幕展示实际考试界面布局
- 步骤导航是编辑器的控制面板，不属于考试界面
- 编辑器的「上一步/下一步」用于导航预览，考试界面内的「下一步」是真实操作按钮

### 11.3 各步骤预览效果

以下展示控制区在不同步骤类型下的显示内容：

#### 倒计时步骤（控制区）

```
┌───────────────────────────────────────────┐
│                 控制区                     │
├───────────────────────────────────────────┤
│                                           │
│                ⏱️ 30                       │  ← 大号倒计时数字（居中）
│                                           │
│   ████████████████████████████████████   │  ← 进度条（满格）
│                                           │
│           请认真阅读以上问题               │  ← 提示文字
│                                           │
│              [开始录音]                   │  ← 跳过按钮（如果配置显示）
│                                           │
└───────────────────────────────────────────┘

预览模式说明: 倒计时显示固定数字，不会真正开始倒计时
```

#### 录音步骤（控制区）

```
┌───────────────────────────────────────────┐
│                 控制区                     │
├───────────────────────────────────────────┤
│                                           │
│              🎤 录音中                     │  ← 状态标题
│                                           │
│          ▁ ▂ ▄ ▆ █ ▆ ▄ ▂ ▁               │  ← 波形动画
│                                           │
│              00:00 / 60                   │  ← 已录时间 / 最大时长
│                                           │
│              [完成录音]                   │  ← 停止按钮（如果配置显示）
│                                           │
└───────────────────────────────────────────┘

预览模式说明: 显示录音 UI，不会真正录音
```

#### 播放音频步骤（控制区）

```
┌───────────────────────────────────────────┐
│                 控制区                     │
├───────────────────────────────────────────┤
│                                           │
│              🔊 正在播放                   │  ← 状态标题
│                                           │
│   ━━━━━━━━━━━━●━━━━━━━━━━  01:25 / 03:00  │  ← 进度条 + 时间
│                                           │
│              [▶ 播放]                     │  ← 播放/暂停按钮（可真实播放）
│                                           │
│          第 1 遍播放，共 2 遍             │  ← 播放遍数（如果配置显示）
│                                           │
└───────────────────────────────────────────┘

预览模式说明: 音频可以真实播放，方便编辑人员检查音频内容
```

#### 完整界面示例（倒计时步骤）

```
┌───────────────────────────────────────────┐
│ ← 短文朗读                         01:30  │  导航栏
├───────────────────────────────────────────┤
│                                           │
│   The quick brown fox jumps over the      │
│   lazy dog. This sentence contains        │  内容区
│   every letter of the alphabet.           │  (显示朗读文本)
│                                           │
├───────────────────────────────────────────┤
│                                           │
│                ⏱️ 25                       │
│                                           │  控制区
│   ████████████████░░░░░░░░░░░░░░░░░░░░   │  (倒计时)
│                                           │
│             请准备朗读                     │
│                                           │
├───────────────────────────────────────────┤
│  [下一大题]                    [下一步]   │  底部按钮栏
└───────────────────────────────────────────┘
```

---

## 十二、实现路线图

### 第一阶段：基础框架（Demo 核心）

1. 定义 TypeScript 类型（`SpeakingStepsQuestion`, 各种 `Step` 类型）
2. 实现题型模板工厂（至少支持 partType=1 短文朗读）
3. 创建 `SpeakingStepsEditor` 基础结构
4. 实现 `StepCard` 组件（折叠/展开）
5. 实现步骤拖拽排序

### 第二阶段：步骤编辑器

1. 实现各类型步骤的编辑组件
   - `StepIntroductionEditor`
   - `StepDisplayContentEditor`
   - `StepPlayAudioEditor`
   - `StepCountdownEditor`
   - `StepRecordEditor`
2. 实现音频选择组件（Demo 用本地文件）
3. 实现步骤添加/删除

### 第三阶段：小题循环

1. 实现 `LoopSubQuestionsStep` 编辑器
2. 实现小题管理面板
3. 实现小题编辑对话框
4. 预览时展开循环

### 第四阶段：预览渲染

1. 实现 `SpeakingStepsRenderer`
2. 实现各步骤渲染组件
3. 实现预览控制器（上一步/下一步）
4. 实现音频真实播放功能

### 优先级建议

**Demo 必须完成**：
- 第一阶段全部
- 第二阶段的 Introduction、DisplayContent、PlayAudio、Countdown、Record 编辑器
- 第四阶段的预览控制器

**可后续完成**：
- 小题循环（第三阶段）
- 数据验证
- 与题库集成

---

## 十三、参考资料

- `口语考试题型流程说明.md` - 现有移动端实现详解
- `CLAUDE.md` - 项目架构说明
- `types/question.ts` - 现有题型定义

---

## 附录：简化版 Demo 方案

如果时间紧张，可以先实现一个简化版 Demo：

### 简化方案

1. **只支持 partType=1 短文朗读**
   - 流程简单：介绍 → 显示内容 → 播放音频 → 倒计时 → 录音
   - 不涉及小题循环

2. **编辑区简化**
   - 固定步骤序列，只允许编辑内容
   - 不支持拖拽排序和添加/删除步骤

3. **预览简化**
   - 只支持手动下一步
   - 音频不真实播放，只显示 UI

这样可以在最短时间内验证核心交互设计。
