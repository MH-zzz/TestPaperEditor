# 题型模板 + 题型流程引擎目标与里程碑（Pilot: 听后选择）

> 更新时间：2026-02-11  
> 维护方式：每次功能迭代完成后，同步更新本文件的「完成度」「下一步」「更新记录」。

## 1. 最终目标（四层解耦）

1. 题型数据独立（题目内容怎么存）
2. 流程规则独立（步骤怎么跑）
3. 绑定策略独立（什么场景用哪套流程）
4. 渲染执行统一（引擎解释执行，不靠页面硬编码）

## 2. 达成效果（验收标准）

1. 编辑员只维护两类资产：`题型模板`（内容）和 `题型流程`（规则），不再手工维护每题完整步骤。
2. 新建题时，自动按“题型模板 + 路由命中流程”生成可执行 flow。
3. 同一题型可按地区/场景/年级命中不同流程版本，无需改页面逻辑。
4. 流程变更优先通过流程模块发布，历史题可追溯命中来源（profile/module/version）。
5. 预览与考试共用同一套执行语义，避免“编辑器能看、考试不一致”。

## 2.1 为什么要这么做（价值说明）

### A. 题型数据独立

- 好处：
  - 题目内容结构稳定，编辑逻辑更简单。
  - 同一份题目数据可复用不同流程，不需要复制题目。
- 业务意义：
  - 标注效率更高，题型扩展更快。
  - 内容团队可独立迭代，不被流程细节绑死。
- 不这么做的风险：
  - 题目与流程耦合后，改一步流程就要改大量题目数据。
  - 数据重复和不一致会持续累积。

### B. 流程规则独立

- 好处：
  - 流程可版本化、可发布、可回滚。
  - 同题型可维护多套标准流程，覆盖不同考试要求。
- 业务意义：
  - 规则变化可以“改一次、全局生效”，降低维护成本。
  - 便于流程评审与合规管控。
- 不这么做的风险：
  - 页面硬编码分叉越来越多，后期改动风险指数上升。
  - 同类题在不同页面行为不一致，质量难保证。

### C. 绑定策略独立

- 好处：
  - 地区/场景/年级差异通过路由策略解决，不污染题型和渲染代码。
  - 可解释“为什么命中这套流程”，便于排错和运营沟通。
- 业务意义：
  - 支持同题型多规范并存（例如不同地市考试规则）。
  - 后续支持灰度发布与逐步切换。
- 不这么做的风险：
  - 需求一多就会出现 if/else 地狱。
  - 特殊场景需求会反复改核心代码，交付节奏不稳定。

### D. 渲染执行统一（引擎解释执行）

- 好处：
  - 预览、编辑联调、考试端使用同一执行语义，行为一致。
  - 新步骤优先通过配置和解释器扩展，不必改大量页面代码。
- 业务意义：
  - 降低跨端不一致导致的线上事故概率。
  - 题型增长时，研发成本接近线性增长而不是指数增长。
- 不这么做的风险：
  - 各页面各写一套流程逻辑，长期不可维护。
  - 回归测试成本高，任何调整都容易引入隐性回归。

## 3. 当前完成度（截至 2026-02-11）

### 3.1 题型数据独立

- 状态：`已完成（听后选择 Pilot）`
- 已落地：
  - `listening_choice` 已拆分为 `content + flow` 数据模型。  
    见 `types/question.ts`
  - 题型模板中心已独立，维护默认内容，不直接维护流程。  
    见 `components/views/ContentTemplatesManager.vue`、`stores/contentTemplates.ts`
  - 新建听后选择题时从模板生成内容并重建 ID。  
    见 `templates/index.ts`

### 3.2 流程规则独立

- 状态：`已完成（听后选择 Pilot）`
- 已落地：
  - 听后选择流程模块（版本化）独立存储与读取。  
    见 `stores/flowModules.ts`
  - 流程中心支持可视化编辑步骤、拖动排序、插入删除、预览联动。  
    见 `components/views/FlowModulesManager.vue`
  - 保存前校验器已接入（错误阻断、警告确认、保存影响确认）。  
    见 `flows/listeningChoiceFlowModules.ts`、`components/views/FlowModulesManager.vue`

### 3.3 绑定策略独立

- 状态：`已完成（听后选择 Pilot）`
- 已落地：
  - Flow Profile 路由策略（题型 + 地区 + 场景 + 年级 -> 模块版本）。  
    见 `stores/flowProfiles.ts`
  - 编辑页支持设置流程上下文（region/scene/grade）。  
    见 `components/views/EditorWorkspace.vue`、`types/question.ts`
  - 流程中心支持路由模拟、冲突/死规则诊断、修复预览。  
    见 `components/views/FlowModulesManager.vue`

### 3.4 渲染执行统一

- 状态：`部分完成（听后选择已接入引擎）`
- 已落地：
  - 听后选择已通过编译器 + runtime reducer 执行步骤推进。  
    见 `engine/flow/listening-choice/compiler.ts`、`engine/flow/listening-choice/runtime.ts`
  - 题目保存时已支持“标准流程 override 检测 / 自动沉淀流程库”。  
    见 `engine/flow/listening-choice/binding.ts`
- 尚未完成：
  - 其他题型尚未接入同一套流程引擎抽象（目前仅听后选择完整）。

## 4. 分解小步骤（从现状到最终目标）

### M1. 听后选择 Pilot 收口（P0）

- [x] 数据模型拆分：`content` 与 `flow`
- [x] 题型模板中心与题型流程中心分离
- [x] Flow Profile 路由与上下文输入
- [x] 流程保存前校验（错误阻断 + 警告确认）
- [x] 发布语义补齐：`另存新版本(v+1)` 与 `归档旧版本`
- [x] 影响分析增强：显示将受影响的 profile 列表（不是只有数量）
- [x] 路由规则批量迁移：同模块旧版本 profile 一键迁移到当前版本

### M2. 执行引擎统一抽象（P0）

- [x] 抽象通用 `FlowModule` / `FlowStep` 协议（跨题型）
- [x] 抽象通用 runtime reducer（next/autoNext/effects）
- [x] 渲染层改为“按 step-kind 插件渲染”，减少题型分支硬编码
- [x] 完成第 2 个题型接入（先以 `speaking_steps` 导航接入通用 runtime 验证通用性）

> M2 当前进展：已完成听后选择的“render-view -> step component”动态渲染，主渲染器保留 runtime 与状态聚合，步骤内容由插件映射组件承接。

### M3. 版本治理与可回溯（P1）

- [x] 模块状态机明确化：draft/published/archived 的 UI 与约束
- [ ] 每次发布生成发布记录（变更摘要、时间、操作者）
- [ ] 题目保存时记录命中 `profileId/moduleRef/version`
- [ ] 提供“流程差异对比”视图（发布前对比）

### M4. 配置中心与协作化（P2）

- [ ] 从本地存储迁移到服务端配置中心
- [ ] 增加权限与审批（谁可发布/回滚）
- [ ] 灰度发布与回滚开关
- [ ] 运行时观测：命中率、异常率、耗时

## 5. 当前“听后选择”标准流程（最新）

1. 介绍页（intro）
2. 对每个题组循环：
3. 播放描述音频（playAudio: description）
4. 倒计时（秒数取题组 `prepareSeconds`）
5. 播放正文音频（playAudio: content，次数取题组音频配置）
6. 答题（answerChoice，答题时长取题组 `answerSeconds`，`0`=不限时）

## 6. 下一步（建议按顺序）

1. 落地 M3：补全 `draft/published/archived` 状态机约束与 UI 提示
2. 落地 M3：增加发布记录与发布前后差异视图
3. 落地 M3：题目保存记录命中 `profileId/moduleRef/version`（可回溯）

## 7. 更新记录

### 2026-02-11

- 新增并确认四层最终目标定义。
- 完成现状盘点并映射到 M1-M4 里程碑。
- 建立持续维护规则：后续每次迭代更新本文件。
- 补充四层架构的价值说明（好处 / 业务意义 / 不这么做的风险）。
- M1 新增：支持「另存新版本」与「归档当前版本」。
- M1 新增：保存确认弹窗显示受影响路由规则明细（含启用/停用状态）。
- 路由解析增强：归档模块不再作为可命中流程版本。
- M1 新增：支持批量迁移路由规则到当前模块版本（用于新版本发布后切换）。
- M2 新增：落地通用流程协议（`FlowModuleProtocol/FlowStepProtocol`）与通用 runtime reducer。
- M2 新增：听后选择 runtime 已复用通用 reducer，行为保持不变。
- M2 新增：听后选择渲染层引入 step-kind 行为插件注册，开始替代硬编码分支。
- M2 新增：`speaking_steps` 导航已复用通用 runtime reducer（next/prev/goToStep）。
- M2 新增：听后选择模板渲染切换到插件映射的 render-view（不再直接依赖 `step.kind` 条件链）。
- M2 新增：听后选择渲染脚本中的步骤类型判断已抽到插件辅助函数，进一步减少硬编码分支。
- M2 新增：听后选择的小题列表渲染已拆为独立组件（`ListeningChoiceQuestionList`），减少主渲染器模板重复。
- M2 新增：步骤上下文头部（标题/题组/描述）已拆为独立组件（`ListeningChoiceStepContext`）。

### 2026-02-12

- M2 新增：听后选择模板层改为动态组件渲染（`displayRenderer` + `displayRendererProps`），不再使用主渲染器中的长 `v-if` 分支链。
- M2 新增：步骤视图组件化落地（`Intro/GroupPrompt/Countdown/PlayAudio/AnswerChoice/Finish/Unsupported`），主渲染器职责收敛为 runtime 与状态聚合。
- M3 新增：流程中心增加模块状态条与状态机按钮（保存草稿 / 发布当前版本 / 归档当前版本）。
- M3 新增：状态流转约束落地（`draft -> published/archived`、`published -> archived`），并阻断“覆盖已发布/已归档版本”。
- M3 新增：路由可绑定版本收敛为“仅已发布”模块，减少草稿误绑定风险。
- M3 新增：流程模块支持“业务名称 + 备注”维护，默认标准外显为“听后选择标准”，路由卡片与可选版本列表优先显示模块名称。
- 文档新增：`docs/题型流程操作手册.md`，并约定后续流程规则变化必须同步更新该手册与本路线记录。
