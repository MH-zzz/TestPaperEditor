# 听后选择 Pilot：V1 / V2 / 最终态方案

> 适用前提：当前项目仍为 demo，可一次性重写，以“长期稳定架构”优先，不做历史兼容包袱。

## 1. 我们要解决的核心问题

当前诉求不是“把听后选择做完”，而是建立一套可扩展到 20+ 流程、多个题型、多个地区规则的基础设施：

1. 题型数据独立（题目内容怎么存）。
2. 流程规则独立（步骤怎么跑）。
3. 绑定策略独立（什么场景用哪套流程）。
4. 渲染执行统一（引擎解释执行，不靠页面硬编码）。

---

## 2. V1 在做什么（一次性重写基座，听后选择 pilot）

## V1 目标

构建“题型模板 + 流程引擎 + 绑定策略”的可运行最小闭环，仅覆盖 `listening_choice`（听后选择）。

## V1 范围（必须落地）

1. **统一数据模型（新）**
   - `QuestionTemplate`：题型数据结构（标题、题组、音频、答题时长等）。
   - `FlowModule`：流程 DSL（步骤序列、步骤参数、显示开关、自动推进规则）。
   - `FlowProfile`：绑定策略（`题型 + 地区 + 场景 -> flowModule@version`）。
   - `QuestionInstance`：实例题，仅保存 `templateData + profileRef + overrides(白名单)`。

2. **流程引擎（新）**
   - `compile(templateData, flowModule, overrides) -> runtimeSteps`
   - `execute(runtimeSteps, runtimeContext) -> currentViewState + nextTransition`
   - 重点：播放音频、倒计时、答题步都由引擎状态驱动。

3. **编辑职责重划分（新）**
   - 题目编辑：只改题型模板数据。
   - 流程中心：只改流程模块和绑定策略。
   - 预览区：只消费引擎输出，不直接读取“散落字段逻辑”。

4. **听后选择标准流程（pilot 基准）**
   - 介绍页
   - 每题组：播放描述音频 -> 倒计时（题组准备时间） -> 播放正文音频（模板播放次数） -> 答题（模板答题时间）

5. **流程校验器（V1 即上线）**
   - 每题组至少有 1 个答题步骤。
   - 步骤引用字段必须存在（如 groupId 可解析）。
   - 禁止无效组合（比如答题前缺题组上下文）。

## V1 非目标（先不做）

1. 不做多题型全面接入。
2. 不做服务端发布平台（先本地/单机流程中心）。
3. 不做复杂权限系统。

## V1 完成标准（验收）

1. 听后选择全链路只通过引擎跑通（编辑、预览、执行一致）。
2. 同一题型能切换不同流程模块，页面无需改代码。
3. 新增/改步骤仅改流程配置，不改 renderer 业务分支。
4. 通过自动化测试覆盖 compile/execute/校验。

---

## 3. V2 在做什么（规模化和治理）

## V2 目标

把 V1 的单题型引擎化能力扩展为“可运营系统”。

## V2 范围

1. **多题型接入机制**
   - 引擎层保持通用，题型差异通过 schema + step handlers 插件化。
   - 先扩到第二题型（建议：笔试选择），验证抽象。

2. **版本与发布治理**
   - FlowModule 强制版本号（不可覆写发布版）。
   - 支持草稿/发布/回滚。
   - 显示影响范围（多少 profile、多少题实例）。

3. **绑定策略增强**
   - 支持优先级和回退链路（学校 -> 地区 -> 全局默认）。
   - 支持按考试批次/学段切换策略。

4. **服务端配置中心（可选但推荐）**
   - 配置同步、审计日志、多人协作发布。

## V2 完成标准（验收）

1. 至少 2 个题型在同一引擎框架内稳定运行。
2. 流程变更可发布、可回滚、可追踪。
3. 区域差异通过 Profile 解决，不需要 fork 题型代码。

---

## 4. 最终态（目标架构）

## 最终目标一句话

“题型是内容数据，流程是规则，Profile 是路由策略，引擎是唯一执行入口”。

## 最终态能力

1. 新增流程 = 配置行为，不改页面代码。
2. 同一题型按地区/场景差异自动命中不同流程版本。
3. 一处改规则，按发布策略影响目标范围。
4. 预览、编辑、正式执行三端行为一致。
5. 流程可测试、可审计、可回滚。

---

## 5. 听后选择 Pilot 的具体实施任务

## M0：冻结当前口径

1. 冻结听后选择字段字典（题组准备时间、题组答题时间、描述/正文播放次数等）。
2. 冻结标准流程定义与步骤名称。

## M1：重建模型与引擎内核

1. 建立新 schema：Template / Module / Profile / Instance。
2. 实现 compile + execute + validate 三核心能力。
3. 写引擎级单元测试（步骤展开、转场、参数来源、错误处理）。

## M2：接入 UI（仅听后选择）

1. 编辑页只编辑模板数据。
2. 流程中心只编辑模块和 profile。
3. 预览和执行都只消费引擎输出状态。

## M3：治理能力

1. 增加版本切换与回滚。
2. 增加流程 diff 与影响分析。
3. 增加保存前校验提示。

## M4：扩展验证

1. 接入第二题型验证抽象。
2. 清理听后选择特化逻辑，沉淀公共 Step Handler 规范。

---

## 6. 需要逐点讨论并定稿的决策清单

1. Profile 的维度到什么粒度（省/市/校/批次）？
2. 标准题是否完全不持久化 `steps`（仅运行时生成）？
3. overrides 白名单边界（允许改哪些，禁止改哪些）？
4. 流程发布是否必须审核？
5. 服务端配置中心是 V2 前期做还是后期做？

---

## 7. 推荐决策（供讨论起点）

1. V1 只做听后选择，不并行扩多题型。
2. V1 就引入 Profile，不要等到 V2。
3. 标准题只存 `source/profile + overrides`，`steps` 不作主数据。
4. 结构性改动（插删步骤）必须生成新模块版本，不允许作为题目 override。
5. 先把“流程引擎正确性测试”做厚，再扩功能。

