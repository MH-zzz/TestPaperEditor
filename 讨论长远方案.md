# 讨论长远方案

## 1. 当前项目架构判断（结论）

当前是**配置驱动的半编译流程模式**：

1. 题目数据里同时存在 `flow.source`（来源）和 `flow.steps`（物化步骤）。
2. 标准流程通过函数把题型数据 + 流程模板“展开”为可执行步骤。
3. 编辑页与流程中心已经开始分离：编辑页侧重题目内容，流程中心侧重规则维护。

这条路线是正确的，已经具备升级成“题型 + 流程引擎”的基础。

## 2. 你的目标是否可行

目标：多个题型、二十多个流程、同题型可按地区/场景走不同流程。  
结论：**可行**，而且是长期可维护的方向。

前提是把模型明确拆成三层：

1. **题型模板层**：只负责题目数据结构与字段（title、题组、音频、答题时长等）。
2. **流程模板层**：只负责步骤顺序和步骤行为（播放、倒计时、答题、提示音等）。
3. **绑定策略层（关键）**：决定“哪个题型在什么地区/场景绑定哪个流程版本”。

## 3. 好处与风险

### 好处

1. 同一题型可复用多套流程，避免复制 UI 和逻辑。
2. 流程改版影响清晰，可控地批量生效。
3. 地区差异通过绑定策略解决，不会把题型代码改乱。
4. 后续新增流程更像“配置发布”，开发成本更低。

### 风险

1. 流程配置复杂度上升，容易出现“能配但不合理”的组合。
2. 若题目里持久化了太多 `steps`，会出现模板变了但题目不跟随的问题。
3. 没有版本治理时，后改流程会影响历史数据，难回溯。
4. 覆盖（override）过多会让流程库失控。

## 4. 建议的长期改进（按优先级）

## P0（必须先做）

1. **引入绑定策略层（Flow Profile）**
   - 建议键：`题型 + 地区 + 考试场景 + 学段(可选)`。
   - 输出：`flowModuleId + version`。

2. **单一真源策略**
   - 标准题：以 `flow.source` 为主，`flow.steps` 尽量运行时物化。
   - 仅在“冻结快照”场景下保存完整 `steps`。

3. **流程版本化**
   - 例如：`listening_choice.standard.v1 / v2`。
   - 禁止无版本覆盖旧规则。

4. **流程合法性校验器**
   - 保存流程前校验：是否存在答题步骤、步骤顺序是否允许、字段来源是否完整。

## P1（强烈建议）

1. **覆盖治理**
   - 白名单覆盖（showTitle、showPrompt 等）可保留。
   - 结构性变化（插删步骤）应沉淀为新流程模板，而非长期 override。

2. **变更影响分析**
   - 保存流程模板时提示影响题量、影响范围（题型/地区/版本）。

3. **可视化差异对比**
   - 新旧流程 diff（步骤顺序、参数、字段来源）便于评审。

## P2（规模化后）

1. **从本地存储迁移到服务端配置中心**
   - 支持多人协作、发布审核、回滚。

2. **灰度发布机制**
   - 新流程先给部分地区/账号试运行，再全量切换。

3. **观察与审计**
   - 记录流程命中率、异常步骤、退回率，做持续优化。

## 5. 我们逐点讨论时建议的问题清单

### 议题 A：绑定策略层

1. 地区维度到什么粒度（省/市/校）？
2. 一个题型允许挂几套“在线”流程？
3. 默认回退策略是什么（找不到地区配置时）？

### 议题 B：版本策略

1. 版本号规则（语义化还是流水号）？
2. 历史题是否锁定旧版本？
3. 什么时候触发“必须升版本”？

### 议题 C：覆盖（override）边界

1. 允许覆盖哪些字段？
2. 何时强制升级成新流程模板？
3. 是否允许编辑人员直接改结构性步骤？

### 议题 D：发布流程

1. 谁可发布流程？
2. 是否需要双人审核？
3. 回滚动作和回滚窗口如何定义？

## 6. 建议的短期落地顺序（可执行）

1. 先定 `Flow Profile` 数据结构（题型+地区+场景 -> 流程版本）。
2. 给现有听后选择流程补上版本号与发布记录字段。
3. 将“标准题”切换为 source 驱动（steps 运行时生成）。
4. 加入流程校验器和保存前校验提示。
5. 再扩展第二个题型流程，验证通用性。

## 7. 当前听后选择（我们已对齐的最新规则）

1. 介绍页（intro）
2. 每题组循环：
3. 播放描述音频（playAudio: description）
4. 倒计时（秒数取题组 `prepareSeconds`）
5. 播放正文音频（playAudio: content，播放次数取题组 `audio.playCount`）
6. 答题（answerChoice，时长取题组 `answerSeconds`，`0` 表示不限时）

